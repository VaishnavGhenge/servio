{{template "layout" .}}

{{define "content"}}
<div class="project-detail">
    <div class="breadcrumb-row">
        <a href="/" class="back-link-subtle">{{template "icon-arrow-left"}} Dashboard</a>
    </div>

    <header class="page-header">
        <div class="header-left">
            <h1>{{.Project.Name}}</h1>
            {{if .Project.Domain}}<span class="domain-badge">{{.Project.Domain}}</span>{{end}}
        </div>
        <div class="header-actions">
            <a href="/services/new?project_id={{.Project.ID}}" class="btn btn-primary">Add Service</a>
            <a href="/projects/{{.Project.ID}}/edit" class="btn btn-secondary">Edit Project</a>
            <form method="POST" action="/projects/{{.Project.ID}}/delete" class="inline-form"
                onsubmit="return confirm('Are you sure you want to delete this project and all its services?')">
                <button type="submit" class="btn btn-danger">Delete Project</button>
            </form>
        </div>
    </header>

    {{if .Error}}
    <div class="alert alert-error">
        <span class="alert-icon">{{template "icon-alert"}}</span>
        {{.Error}}
    </div>
    {{end}}

    <!-- Nginx Section -->
    {{if .Project.Domain}}
    <div class="card nginx-section">
        <div class="card-title">
            <span>Nginx Configuration</span>
            <span class="nginx-status" id="nginx-status">...</span>
        </div>
        <div class="nginx-actions">
            <button class="btn btn-secondary" onclick="togglePreview()">Edit Config</button>
            <button class="btn btn-secondary" onclick="resetConfig()" id="reset-btn" style="display:none;">Reset to Default</button>
            <button class="btn btn-primary" onclick="saveAndDeploy()" id="deploy-btn">Save & Deploy</button>
            <button class="btn btn-danger" onclick="removeNginx()" id="remove-btn" style="display:none;">Remove</button>
        </div>
        <div class="nginx-preview" id="nginx-preview" style="display:none;">
            <div class="config-container">
                <pre id="nginx-view" class="config-view"></pre>
                <textarea id="nginx-config" class="config-edit" rows="20" spellcheck="false" oninput="syncEditToView()"></textarea>
            </div>
            <div class="nginx-preview-actions">
                <small id="config-hint">Click "Edit Config" to switch between view and edit modes.</small>
            </div>
        </div>
    </div>
    {{else}}
    <div class="card nginx-section-empty">
        <p>Set a <strong>Domain</strong> on this project to enable Nginx reverse proxy.</p>
        <a href="/projects/{{.Project.ID}}/edit" class="btn btn-secondary">Edit Project</a>
    </div>
    {{end}}

    <div class="services-list">
        {{range .Project.Services}}
        <div class="card service-item-card">
            <div class="service-item-header">
                <div>
                    <h3 class="service-name">{{.Name}} <span class="service-type-tag">{{.Type}}</span></h3>
                    <span class="status-badge status-{{.Status}}">{{.Status}}</span>
                    {{if .Port}}<span class="port-badge">:{{.Port}}</span>{{end}}
                </div>
                <div class="service-item-actions">
                    {{if eq .Status "running"}}
                    <form method="POST" action="/services/{{.ID}}/stop" class="inline-form">
                        <button type="submit" class="btn btn-danger btn-sm">Stop</button>
                    </form>
                    <form method="POST" action="/services/{{.ID}}/restart" class="inline-form">
                        <button type="submit" class="btn btn-warning btn-sm">Restart</button>
                    </form>
                    {{else if eq .Status "stopped"}}
                    <form method="POST" action="/services/{{.ID}}/start" class="inline-form">
                        <button type="submit" class="btn btn-success btn-sm">Start</button>
                    </form>
                    {{else}}
                    <form method="POST" action="/services/{{.ID}}/install" class="inline-form">
                        <button type="submit" class="btn btn-primary btn-sm">Install</button>
                    </form>
                    {{end}}
                    <form method="POST" action="/services/{{.ID}}/delete" class="inline-form" onsubmit="return confirm('Delete this service?')">
                        <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                    </form>
                </div>
            </div>
            
            <div class="service-details-row">
                <div class="detail-col">
                    <label>Command</label>
                    <code>{{.Command}}</code>
                </div>
                <div class="detail-col">
                    <label>Working Dir</label>
                    <code>{{if .WorkingDir}}{{.WorkingDir}}{{else}}/{{end}}</code>
                </div>
            </div>

            <details class="service-config-details">
                <summary>View Systemd Configuration</summary>
                <div class="config-container">
                    <pre class="config-view code-block" data-language="systemd" id="svc-conf-{{.ID}}">{{.SystemdRaw}}</pre>
                </div>
            </details>
        </div>
        {{else}}
        <div class="empty-state">
            <p>No services yet in this project.</p>
            <a href="/services/new?project_id={{.Project.ID}}" class="btn btn-primary">Add Your First Service</a>
        </div>
        {{end}}
    </div>
</div>

<script data-project-id="{{.Project.ID}}">
const projectId = document.currentScript.getAttribute('data-project-id');
let defaultConfig = '';
let isCustomized = false;

async function checkNginxStatus() {
    try {
        const res = await fetch(`/api/nginx/${projectId}/preview`);
        const data = await res.json();
        const statusEl = document.getElementById('nginx-status');
        const deployBtn = document.getElementById('deploy-btn');
        const removeBtn = document.getElementById('remove-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        defaultConfig = data.default_config || '';
        isCustomized = data.is_customized;
        
        if (data.installed) {
            statusEl.textContent = 'Deployed' + (isCustomized ? ' (Modified)' : '');
            statusEl.className = 'nginx-status nginx-deployed';
            deployBtn.textContent = 'Save & Re-deploy';
            removeBtn.style.display = 'inline-flex';
        } else {
            statusEl.textContent = 'Not Deployed' + (isCustomized ? ' (Modified)' : '');
            statusEl.className = 'nginx-status nginx-not-deployed';
            deployBtn.textContent = 'Save & Deploy';
            removeBtn.style.display = 'none';
        }
    } catch (e) {
        document.getElementById('nginx-status').textContent = 'Error';
    }
}

async function togglePreview() {
    const preview = document.getElementById('nginx-preview');
    const view = document.getElementById('nginx-view');
    const edit = document.getElementById('nginx-config');
    const resetBtn = document.getElementById('reset-btn');
    const hint = document.getElementById('config-hint');
    
    if (preview.style.display === 'none') {
        // First open: show VIEW mode
        try {
            const res = await fetch(`/api/nginx/${projectId}/preview`);
            const data = await res.json();
            edit.value = data.config || '';
            defaultConfig = data.default_config || '';
            isCustomized = data.is_customized;
            
            view.innerHTML = highlightNginx(edit.value);
            view.style.display = 'block';
            edit.style.display = 'none';
        } catch (e) {
            view.textContent = 'Error loading config';
        }
        preview.style.display = 'block';
        resetBtn.style.display = isCustomized ? 'inline-flex' : 'none';
        hint.textContent = 'Click "Edit Config" to modify the configuration.';
    } else {
        // Toggle between VIEW and EDIT if already open
        if (edit.style.display === 'none') {
            edit.style.display = 'block';
            view.style.display = 'none';
            hint.textContent = 'Editing mode. Changes are synced to view.';
        } else {
            view.innerHTML = highlightNginx(edit.value);
            view.style.display = 'block';
            edit.style.display = 'none';
            hint.textContent = 'View mode. Click "Edit Config" to switch back.';
        }
    }
}

function syncEditToView() {
    const edit = document.getElementById('nginx-config');
    const view = document.getElementById('nginx-view');
    if (edit && view) {
        view.innerHTML = highlightNginx(edit.value);
    }
}

function resetConfig() {
    const edit = document.getElementById('nginx-config');
    if (confirm('Reset to auto-generated config? Your customizations will be lost.')) {
        edit.value = defaultConfig;
        syncEditToView();
    }
}

async function saveAndDeploy() {
    const textarea = document.getElementById('nginx-config');
    const config = textarea.value;
    
    if (!confirm('Save and deploy this Nginx configuration?')) return;
    
    try {
        // First save the custom config to project
        const saveRes = await fetch(`/api/nginx/${projectId}/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ config: config })
        });
        const saveData = await saveRes.json();
        if (saveData.error) {
            alert('Save failed: ' + saveData.error);
            return;
        }
        
        // Then deploy
        const deployRes = await fetch(`/api/nginx/${projectId}/deploy`, { method: 'POST' });
        const deployData = await deployRes.json();
        if (deployData.error) {
            alert('Deploy failed: ' + deployData.error);
        } else {
            alert('Nginx configuration saved and deployed!');
            checkNginxStatus();
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function removeNginx() {
    if (!confirm('Remove Nginx configuration for this project?')) return;
    
    try {
        const res = await fetch(`/api/nginx/${projectId}/remove`, { method: 'POST' });
        const data = await res.json();
        if (data.error) {
            alert('Remove failed: ' + data.error);
        } else {
            alert('Nginx configuration removed');
            document.getElementById('nginx-preview').style.display = 'none';
            document.getElementById('reset-btn').style.display = 'none';
            checkNginxStatus();
        }
    } catch (e) {
        alert('Remove failed: ' + e.message);
    }
}

// Check status on load
if (document.getElementById('nginx-status')) {
    checkNginxStatus();
}
</script>
{{end}}