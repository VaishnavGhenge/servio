{{template "layout" .}}

{{define "content"}}
<div class="service-form-page">
    <header class="page-header">
        <h1>{{if .Edit}}Edit Service{{else}}Add Service{{end}}</h1>
        <a href="/projects/{{.ProjectID}}" class="btn btn-secondary">Cancel</a>
    </header>

    {{if .Error}}
    <div class="alert alert-error">
        <span class="alert-icon">{{template "icon-alert"}}</span>
        {{.Error}}
    </div>
    {{end}}

    <div class="form-with-preview">
        <!-- Left: Form -->
        <form method="POST" class="project-form card" id="service-form">
            <div class="card-title">Service Configuration</div>

            <div class="form-group">
                <label for="name">Service Name</label>
                <input type="text" id="name" name="name" value="{{.Service.Name}}" required pattern="[a-zA-Z0-9_\-]+"
                    placeholder="my-backend" {{if .Edit}}readonly{{end}}>
                <small>Lowercase, numbers, and hyphens only.</small>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="type">Service Type</label>
                    <select id="type" name="type" class="form-control" {{if .Edit}}disabled{{end}}>
                        <option value="custom" {{if eq .Service.Type "custom"}}selected{{end}}>Custom Command</option>
                        <option value="django" {{if eq .Service.Type "django"}}selected{{end}}>Django/Gunicorn</option>
                    </select>
                    {{if .Edit}}<input type="hidden" name="type" value="{{.Service.Type}}">{{end}}
                    {{if .Edit}}<small>Service type cannot be changed</small>{{end}}
                </div>

                <div class="form-group" id="version-group">
                    <label for="version">Version</label>
                    <select id="version" name="version" class="form-control" {{if .Edit}}disabled{{end}}>
                        <option value="{{.Service.Version}}">{{if .Service.Version}}{{.Service.Version}}{{else}}Latest{{end}}</option>
                    </select>
                    {{if .Edit}}<input type="hidden" name="version" value="{{.Service.Version}}">{{end}}
                </div>
            </div>

            <div class="form-group" id="command-group">
                <label for="command">Command</label>
                <input type="text" id="command" name="command" value="{{.Service.Command}}"
                    placeholder="npm start">
                <small id="command-hint">The start command for your service.</small>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="working_dir">Working Directory</label>
                    <input type="text" id="working_dir" name="working_dir" value="{{.Service.WorkingDir}}"
                        placeholder="/var/www/my-app">
                </div>

                <div class="form-group">
                    <label for="user">User</label>
                    <input type="text" id="user" name="user" value="{{.Service.User}}" placeholder="www-data">
                </div>

                <div class="form-group">
                    <label for="port">Service Port</label>
                    <input type="number" id="port" name="port" value="{{if .Service.Port}}{{.Service.Port}}{{end}}"
                        placeholder="8000" min="1" max="65535">
                    <small id="port-hint">Internal port the service listens on.</small>
                </div>
            </div>


            <div class="form-group">
                <label for="environment">Environment Variables</label>
                <textarea id="environment" name="environment" rows="3"
                    placeholder="PORT=8080&#10;DEBUG=true">{{.Service.Environment}}</textarea>
                <small>Additional environment variables (KEY=VALUE per line)</small>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="auto_restart" name="auto_restart" {{if .Service.AutoRestart}}checked{{end}}>
                    <span class="checkbox-custom"></span>
                    <span class="checkbox-text">Auto-restart on failure</span>
                </label>
            </div>

            <!-- Expert Mode Collapse -->
            <details class="expert-section">
                <summary>Expert Mode (Raw Systemd Override)</summary>
                <div class="expert-content">
                    <div class="form-group">
                        <label for="systemd_raw">Raw Systemd Unit</label>
                        <div class="config-container">
                            <pre id="systemd-view" class="config-view"></pre>
                            <textarea id="systemd_raw" name="systemd_raw" class="config-edit" rows="8" 
                                oninput="updateSystemdView()" placeholder="Paste complete systemd unit to override...">{{.Service.SystemdRaw}}</textarea>
                        </div>
                        <small>If provided, this will completely replace the generated config.</small>
                    </div>
                </div>
            </details>


            <div class="form-actions">
                <button type="submit" class="btn btn-primary">{{if .Edit}}Update Service{{else}}Create Service{{end}}</button>
            </div>
        </form>

        <!-- Right: Live Preview -->
        <div class="config-preview card">
            <div class="card-title">
                <span>Systemd Unit Preview</span>
                <span class="preview-badge" style="background: rgba(var(--color-primary-rgb), 0.2); color: var(--color-primary);">PREVIEW</span>
            </div>

            <div class="preview-content" id="preview-systemd">
                <pre id="systemd-preview" class="code-preview code-block" data-language="systemd">[Unit]
Description=Managed Service: my-backend
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/my-app
ExecStart=/var/www/my-app/npm start
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal
SyslogIdentifier=servio-my-backend

[Install]
WantedBy=multi-user.target</pre>
            </div>

            <p class="preview-hint">Nginx config is managed at the Project level.</p>
        </div>
    </div>
</div>

<script>
(function() {
    const versionMap = {
        django: ['22.0', '21.2', '20.1'],
        custom: []
    };

    const typeDefaults = {
        django: {
            command: 'gunicorn --workers 2 --bind 0.0.0.0:8000 app.wsgi:application',
            user: 'www-data',
            working_dir: '/var/www/app',
            hint: 'Gunicorn command. Configure workers and bind address.'
        },
        custom: {
            command: '',
            user: '',
            working_dir: '',
            hint: 'Enter the command to start your service.'
        }
    };

    const typeSelect = document.getElementById('type');
    const versionSelect = document.getElementById('version');
    const versionGroup = document.getElementById('version-group');
    const commandInput = document.getElementById('command');
    const commandHint = document.getElementById('command-hint');
    const commandGroup = document.getElementById('command-group');
    const userInput = document.getElementById('user');
    const workingDirInput = document.getElementById('working_dir');
    const nameInput = document.getElementById('name');
    const envInput = document.getElementById('environment');
    const autoRestartInput = document.getElementById('auto_restart');
    const systemdPreview = document.getElementById('systemd-preview');

    // Parse existing service config if in edit mode
    const existingConfig = {{if .Service.Config}}{{.Service.Config}}{{else}}'{}'{{end}};
    let serviceConfig = {};
    try {
        serviceConfig = JSON.parse(existingConfig);
    } catch(e) {
        serviceConfig = {};
    }

    // Check if we're in edit mode
    const isEditMode = {{if .Edit}}true{{else}}false{{end}};

    function updateVersionOptions() {
        const type = typeSelect.value;
        const versions = versionMap[type] || [];

        versionSelect.innerHTML = '<option value="">Latest</option>';
        versions.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            versionSelect.appendChild(opt);
        });

        versionGroup.style.display = versions.length > 0 ? 'block' : 'none';

        const portHint = document.getElementById('port-hint');
        portHint.textContent = 'Port for Nginx proxy (leave empty if not exposing via web).';

        // Only apply defaults when NOT in edit mode
        if (!isEditMode) {
            const defaults = typeDefaults[type];
            if (defaults && type !== 'custom') {
                commandInput.value = defaults.command;
                commandInput.placeholder = defaults.command;
                commandHint.textContent = defaults.hint;
                userInput.value = defaults.user;
                workingDirInput.value = defaults.working_dir;
            } else {
                // Clear or reset for custom
                commandInput.value = '';
                commandInput.placeholder = 'npm start';
                userInput.value = '';
                userInput.placeholder = 'www-data';
                workingDirInput.value = '';
                workingDirInput.placeholder = '/var/www/my-app';
                commandHint.textContent = 'The start command for your service.';
            }
        } else {
            // In edit mode, just update hints
            const defaults = typeDefaults[type];
            if (defaults) {
                commandHint.textContent = defaults.hint;
            }
        }

        updatePreview();
    }

    function updatePreview() {
        const name = nameInput.value || 'my-service';
        const type = typeSelect.value;
        const user = userInput.value || 'root';
        const workDir = workingDirInput.value || '/';
        const command = commandInput.value || 'echo "No command"';
        const env = envInput.value || '';
        const autoRestart = autoRestartInput.checked;

        // Build environment lines
        let envLines = '';
        if (env.trim()) {
            env.split('\n').forEach(line => {
                line = line.trim();
                if (line && line.includes('=')) {
                    envLines += `Environment="${line}"\n`;
                }
            });
        }

        // Resolve command path
        let execStart = command;
        if (!command.startsWith('/')) {
            execStart = workDir + '/' + command;
        }

        const systemdUnit = `[Unit]
Description=Managed Service: ${name}
After=network.target

[Service]
Type=simple
User=${user}
WorkingDirectory=${workDir}
ExecStart=${execStart}
Restart=${autoRestart ? 'on-failure' : 'no'}
RestartSec=5
StandardOutput=journal
StandardError=journal
SyslogIdentifier=servio-${name}
${envLines}
[Install]
WantedBy=multi-user.target`;

        systemdPreview.innerHTML = highlightSystemd(systemdUnit);
    }

    // Event listeners
    typeSelect.addEventListener('change', updateVersionOptions);
    versionSelect.addEventListener('change', updatePreview);
    nameInput.addEventListener('input', updatePreview);
    commandInput.addEventListener('input', updatePreview);
    userInput.addEventListener('input', updatePreview);
    workingDirInput.addEventListener('input', updatePreview);
    envInput.addEventListener('input', updatePreview);
    autoRestartInput.addEventListener('change', updatePreview);

    // Tab switching
    document.querySelectorAll('.preview-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.preview-content').forEach(c => c.classList.add('hidden'));
            this.classList.add('active');
            document.getElementById('preview-' + this.dataset.tab).classList.remove('hidden');
        });
    });

    function updateSystemdView() {
        const edit = document.getElementById('systemd_raw');
        const view = document.getElementById('systemd-view');
        if (edit && view) {
            view.innerHTML = highlightSystemd(edit.value);
        }
    }

    // Initialize
    updateVersionOptions();
    updateSystemdView();

})();
</script>
{{end}}
